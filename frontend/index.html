<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mac Status PWA</title>
    <meta name="description" content="パーソナライズされたMac監視・ステータス報告ツール">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#007AFF">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Mac Status">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/static/manifest.json">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="/static/icons/icon-192x192.png">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="/static/styles.css">
    <link rel="stylesheet" href="/static/assets/video-styles.css">
</head>
<body>
    <div id="app">
        <header class="app-header">
            <h1>Mac Status</h1>
            <div class="connection-status" id="connectionStatus">
                <span class="status-indicator"></span>
                <span class="status-text">接続中...</span>
            </div>
        </header>
        
        <main class="chat-container">
            <!-- System Status Display -->
            <div class="system-status-container" id="systemStatusContainer">
                <div class="status-cards">
                    <div class="status-card cpu-card" id="cpuCard">
                        <div class="status-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                                <rect x="4" y="4" width="16" height="16" rx="2" stroke="currentColor" stroke-width="2"/>
                                <rect x="9" y="9" width="6" height="6" rx="1" stroke="currentColor" stroke-width="2"/>
                                <path d="M9 1V3M15 1V3M9 21V23M15 21V23M1 9H3M1 15H3M21 9H23M21 15H23" stroke="currentColor" stroke-width="2"/>
                            </svg>
                        </div>
                        <div class="status-content">
                            <div class="status-label">CPU</div>
                            <div class="status-value" id="cpuValue">--</div>
                            <div class="status-bar">
                                <div class="status-bar-fill" id="cpuBar"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="status-card memory-card" id="memoryCard">
                        <div class="status-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                                <rect x="3" y="4" width="18" height="16" rx="2" stroke="currentColor" stroke-width="2"/>
                                <path d="M7 8V16M11 8V16M15 8V16M17 8V16" stroke="currentColor" stroke-width="2"/>
                            </svg>
                        </div>
                        <div class="status-content">
                            <div class="status-label">メモリ</div>
                            <div class="status-value" id="memoryValue">--</div>
                            <div class="status-bar">
                                <div class="status-bar-fill" id="memoryBar"></div>
                            </div>
                            <div class="status-detail" id="memoryDetail">-- / --</div>
                        </div>
                    </div>
                    
                    <div class="status-card disk-card" id="diskCard">
                        <div class="status-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                                <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2"/>
                            </svg>
                        </div>
                        <div class="status-content">
                            <div class="status-label">ディスク</div>
                            <div class="status-value" id="diskValue">--</div>
                            <div class="status-bar">
                                <div class="status-bar-fill" id="diskBar"></div>
                            </div>
                            <div class="status-detail" id="diskDetail">-- / --</div>
                        </div>
                    </div>
                </div>
                
                <div class="status-toggle" id="statusToggle">
                    <button class="toggle-btn" id="toggleBtn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                            <path d="M18 15L12 9L6 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                </div>
            </div>
            
            <div class="messages-wrapper">
                <div class="messages" id="messages">
                    <div class="welcome-message">
                        <!-- メイン動画エリア -->
                        <div class="main-video-container">
                            <div id="mainVideo" class="main-video"></div>
                        </div>
                    </div>
                </div>
                <div class="scroll-to-bottom" id="scrollToBottom" style="display: none;">
                    <button class="scroll-btn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                            <path d="M7 14L12 19L17 14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                </div>
                
                <!-- Queued messages indicator -->
                <div class="queued-messages-indicator" id="queuedMessagesIndicator">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                        <path d="M12 2L2 7L12 12L22 7L12 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M2 17L12 22L22 17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M2 12L12 17L22 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span id="queuedMessagesCount">0</span> メッセージ待機中
                </div>
            </div>
            
            <div class="typing-indicator" id="typingIndicator" style="display: none;">
                <div class="typing-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                <span class="typing-text">アシスタントが入力中...</span>
            </div>
            
            <div class="input-container">
                <div class="message-input-wrapper">
                    <input type="text" id="messageInput" placeholder="メッセージを入力..." autocomplete="off" maxlength="500">
                    <div class="input-actions">
                        <button id="clearButton" type="button" class="action-btn" title="履歴をクリア">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                                <path d="M3 6H21M8 6V4C8 3.44772 8.44772 3 9 3H15C15.5523 3 16 3.44772 16 4V6M19 6V20C19 20.5523 18.4477 21 18 21H6C5.44772 21 5 20.5523 5 20V6H19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                        <button id="sendButton" type="button" class="send-btn">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                                <path d="M2 21L23 12L2 3V10L17 12L2 14V21Z" fill="currentColor"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="input-footer">
                    <span class="character-count" id="characterCount">0/500</span>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Scripts -->
    <script src="/static/assets/video-component.js"></script>
    <script src="/static/app.js"></script>
    
    <!-- Video Styles -->
    <style>
        /* 中央メイン動画のスタイル */
        .welcome-message {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px 20px;
        }
        
        .main-video-container {
            position: relative;
        }
        
        .main-video {
            width: 400px;
            height: 300px;
        }
        
        /* メイン動画専用のスタイル - 人物部分のみ表示 */
        .main-video .video-container {
            width: 400px;
            height: 300px;
            border-radius: 20px;
            border: none;
            box-shadow: 0 16px 64px rgba(0, 0, 0, 0.15);
            background: transparent;
            position: relative;
            overflow: hidden;
        }
        
        .main-video .video-element {
            width: 400px;
            height: 300px;
            object-fit: cover;
            border-radius: 20px;
            position: relative;
            z-index: 1;
        }
        
        /* 人物部分以外を隠すオーバーレイ - より自然な表示 */
        .main-video .video-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                /* 左側のオーバーレイ */
                linear-gradient(
                    to right,
                    rgba(245, 245, 247, 0.98) 0%,
                    rgba(245, 245, 247, 0.95) 20%,
                    rgba(245, 245, 247, 0.7) 30%,
                    transparent 40%
                ),
                /* 右側のオーバーレイ */
                linear-gradient(
                    to left,
                    rgba(245, 245, 247, 0.98) 0%,
                    rgba(245, 245, 247, 0.95) 20%,
                    rgba(245, 245, 247, 0.7) 30%,
                    transparent 40%
                );
            z-index: 2;
            pointer-events: none;
            border-radius: 20px;
        }
        
        /* 上下の余白を少し隠す */
        .main-video .video-container::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                /* 上部のオーバーレイ */
                linear-gradient(
                    to bottom,
                    rgba(245, 245, 247, 0.4) 0%,
                    rgba(245, 245, 247, 0.2) 10%,
                    transparent 20%
                ),
                /* 下部のオーバーレイ */
                linear-gradient(
                    to top,
                    rgba(245, 245, 247, 0.4) 0%,
                    rgba(245, 245, 247, 0.2) 10%,
                    transparent 20%
                );
            z-index: 3;
            pointer-events: none;
            border-radius: 20px;
        }
        
        /* マスクセレクターを非表示 */
        .main-video .mask-selector {
            display: none;
        }
        
        /* レスポンシブ対応 - メイン動画 */
        @media (max-width: 768px) {
            .main-video {
                width: 320px;
                height: 240px;
            }
            
            .main-video .video-container,
            .main-video .video-element {
                width: 320px;
                height: 240px;
            }
            
            /* タブレット用のオーバーレイ調整 */
            .main-video .video-container::before {
                background: 
                    linear-gradient(
                        to right,
                        rgba(245, 245, 247, 0.98) 0%,
                        rgba(245, 245, 247, 0.95) 15%,
                        rgba(245, 245, 247, 0.7) 25%,
                        transparent 35%
                    ),
                    linear-gradient(
                        to left,
                        rgba(245, 245, 247, 0.98) 0%,
                        rgba(245, 245, 247, 0.95) 15%,
                        rgba(245, 245, 247, 0.7) 25%,
                        transparent 35%
                    );
            }
        }
        
        @media (max-width: 480px) {
            .main-video {
                width: 280px;
                height: 210px;
            }
            
            .main-video .video-container,
            .main-video .video-element {
                width: 280px;
                height: 210px;
            }
            
            .welcome-message {
                padding: 20px 10px;
            }
            
            /* モバイル用のオーバーレイ調整 */
            .main-video .video-container::before {
                background: 
                    linear-gradient(
                        to right,
                        rgba(245, 245, 247, 0.98) 0%,
                        rgba(245, 245, 247, 0.95) 10%,
                        rgba(245, 245, 247, 0.7) 20%,
                        transparent 30%
                    ),
                    linear-gradient(
                        to left,
                        rgba(245, 245, 247, 0.98) 0%,
                        rgba(245, 245, 247, 0.95) 10%,
                        rgba(245, 245, 247, 0.7) 20%,
                        transparent 30%
                    );
            }
        }
    </style>

    <!-- Service Worker Registration -->
    <script>
        // Video component initialization
        let mainVideoComponent = null;
        
        function initializeMainVideo() {
            // メイン動画の初期化（中央エリア用・音声ON）
            const videoSrc = '/static/assets/videos/apple.mp4';
            
            try {
                mainVideoComponent = new VideoComponent('mainVideo', {
                    videoSrc: videoSrc,
                    maskType: 'none', // マスクなし
                    size: 'custom', // カスタムサイズ（CSSで400x300px指定）
                    autoplay: true,
                    loop: true,
                    muted: false, // 音声ON！
                    controls: true, // コントロール表示
                    showMaskSelector: false // マスクセレクターを非表示
                });
                
                console.log('Main video initialized successfully with sound ON');
            } catch (error) {
                console.error('Failed to initialize main video:', error);
                showMainVideoPlaceholder();
            }
        }
        
        function showMainVideoPlaceholder() {
            const container = document.getElementById('mainVideo');
            if (container) {
                container.innerHTML = `
                    <div class="main-video-placeholder" style="
                        width: 400px; 
                        height: 300px; 
                        border-radius: 20px;
                        background: linear-gradient(45deg, #f0f0f0 25%, transparent 25%);
                        background-size: 20px 20px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: #666;
                        font-size: 16px;
                        border: 4px solid rgba(103, 126, 234, 0.3);
                    ">
                        🎬 動画を読み込み中...
                    </div>
                `;
            }
        }
        
        // 動画ファイルの存在確認
        function checkVideoExists(videoSrc) {
            return fetch(videoSrc, { method: 'HEAD' })
                .then(response => response.ok)
                .catch(() => false);
        }
        
        // 音声付き動画の再生を開始（ユーザーインタラクション後）
        function enableMainVideoSound() {
            if (mainVideoComponent && mainVideoComponent.video) {
                mainVideoComponent.video.muted = false;
                mainVideoComponent.video.play().then(() => {
                    console.log('Main video playing with sound');
                }).catch(error => {
                    console.log('Autoplay with sound failed, user interaction required:', error);
                });
            }
        }
        
        // ページクリック時に音声を有効化
        function setupSoundActivation() {
            const activateSound = () => {
                enableMainVideoSound();
                document.removeEventListener('click', activateSound);
                document.removeEventListener('keydown', activateSound);
                console.log('Sound activation listeners removed');
            };
            
            document.addEventListener('click', activateSound);
            document.addEventListener('keydown', activateSound);
            console.log('Sound activation listeners added');
        }
        
        // 動画初期化を実行
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                const videoSrc = '/static/assets/videos/apple.mp4';
                checkVideoExists(videoSrc).then(exists => {
                    if (exists) {
                        // 中央のメイン動画を初期化（音声ON・マスクなし）
                        initializeMainVideo();
                        // 音声有効化のためのユーザーインタラクション待機
                        setupSoundActivation();
                    } else {
                        console.log('Video not found, showing placeholder');
                        showMainVideoPlaceholder();
                    }
                });
            }, 1000);
        });

        // Handle PWA shortcuts
        const urlParams = new URLSearchParams(window.location.search);
        const action = urlParams.get('action');
        
        if (action === 'status') {
            // Focus on system status when opened via status shortcut
            document.addEventListener('DOMContentLoaded', () => {
                const statusContainer = document.getElementById('systemStatusContainer');
                if (statusContainer) {
                    statusContainer.scrollIntoView({ behavior: 'smooth' });
                    statusContainer.classList.add('highlight');
                    setTimeout(() => statusContainer.classList.remove('highlight'), 2000);
                }
            });
        } else if (action === 'chat') {
            // Focus on chat input when opened via chat shortcut
            document.addEventListener('DOMContentLoaded', () => {
                const messageInput = document.getElementById('messageInput');
                if (messageInput) {
                    messageInput.focus();
                }
            });
        }
        
        // Service Worker registration with enhanced error handling
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/static/sw.js')
                    .then(registration => {
                        console.log('SW registered: ', registration);
                        
                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            console.log('New service worker found');
                            
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    console.log('New service worker installed, update available');
                                }
                            });
                        });
                    })
                    .catch(registrationError => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
        
        // Handle app shortcuts and protocol handlers
        if ('launchQueue' in window) {
            window.launchQueue.setConsumer((launchParams) => {
                if (launchParams.targetURL) {
                    const url = new URL(launchParams.targetURL);
                    const handler = url.searchParams.get('handler');
                    
                    if (handler) {
                        console.log('Handling protocol:', handler);
                        // Handle custom protocol if needed
                    }
                }
            });
        }
    </script>
</body>
</html>