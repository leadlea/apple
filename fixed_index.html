<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mac Status PWA - Fixed</title>
    <link rel="stylesheet" href="/static/styles.css">
    <link rel="stylesheet" href="/static/assets/video-styles.css">
    <style>
        /* ヘッダーレイアウトの調整 */
        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 0 0 20px 20px;
            margin-bottom: 20px;
        }
        
        .app-header h1 {
            margin: 0;
            font-size: 28px;
            font-weight: 600;
        }
        
        /* レスポンシブ対応 */
        @media (max-width: 768px) {
            .app-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
        }
        
        /* 中央メイン動画のスタイル */
        .welcome-message {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px 20px;
        }
        
        .main-video-container {
            position: relative;
        }
        
        .main-video {
            width: 400px;
            height: 300px;
        }
        
        /* メイン動画専用のスタイル - 人物部分のみ表示 */
        .main-video .video-container {
            width: 400px;
            height: 300px;
            border-radius: 20px;
            border: none; /* 紫の枠線を削除 */
            box-shadow: 0 16px 64px rgba(0, 0, 0, 0.15);
            background: transparent;
            position: relative;
            overflow: hidden;
        }
        
        .main-video .video-element {
            width: 400px;
            height: 300px;
            object-fit: cover;
            border-radius: 20px;
            position: relative;
            z-index: 1;
        }
        
        /* 人物部分以外を隠すオーバーレイ - より自然な表示 */
        .main-video .video-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                /* 左側のオーバーレイ */
                linear-gradient(
                    to right,
                    rgba(245, 245, 247, 0.98) 0%,
                    rgba(245, 245, 247, 0.95) 20%,
                    rgba(245, 245, 247, 0.7) 30%,
                    transparent 40%
                ),
                /* 右側のオーバーレイ */
                linear-gradient(
                    to left,
                    rgba(245, 245, 247, 0.98) 0%,
                    rgba(245, 245, 247, 0.95) 20%,
                    rgba(245, 245, 247, 0.7) 30%,
                    transparent 40%
                );
            z-index: 2;
            pointer-events: none;
            border-radius: 20px;
        }
        
        /* 上下の余白を少し隠す */
        .main-video .video-container::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                /* 上部のオーバーレイ */
                linear-gradient(
                    to bottom,
                    rgba(245, 245, 247, 0.4) 0%,
                    rgba(245, 245, 247, 0.2) 10%,
                    transparent 20%
                ),
                /* 下部のオーバーレイ */
                linear-gradient(
                    to top,
                    rgba(245, 245, 247, 0.4) 0%,
                    rgba(245, 245, 247, 0.2) 10%,
                    transparent 20%
                );
            z-index: 3;
            pointer-events: none;
            border-radius: 20px;
        }
        
        /* マスクセレクターを非表示 */
        .main-video .mask-selector {
            display: none;
        }
        

        
        /* レスポンシブ対応 - メイン動画 */
        @media (max-width: 768px) {
            .main-video {
                width: 320px;
                height: 240px;
            }
            
            .main-video .video-container,
            .main-video .video-element {
                width: 320px;
                height: 240px;
            }
            
            /* タブレット用のオーバーレイ調整 */
            .main-video .video-container::before {
                background: linear-gradient(
                    to right,
                    rgba(245, 245, 247, 0.95) 0%,
                    rgba(245, 245, 247, 0.95) 20%,
                    transparent 30%,
                    transparent 70%,
                    rgba(245, 245, 247, 0.95) 80%,
                    rgba(245, 245, 247, 0.95) 100%
                );
            }
        }
        
        @media (max-width: 480px) {
            .main-video {
                width: 280px;
                height: 210px;
            }
            
            .main-video .video-container,
            .main-video .video-element {
                width: 280px;
                height: 210px;
            }
            
            .welcome-message {
                padding: 20px 10px;
            }
            
            /* モバイル用のオーバーレイ調整 */
            .main-video .video-container::before {
                background: linear-gradient(
                    to right,
                    rgba(245, 245, 247, 0.95) 0%,
                    rgba(245, 245, 247, 0.95) 15%,
                    transparent 25%,
                    transparent 75%,
                    rgba(245, 245, 247, 0.95) 85%,
                    rgba(245, 245, 247, 0.95) 100%
                );
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <header class="app-header">
            <h1>Mac Status</h1>
            <div class="connection-status" id="connectionStatus">
                <span class="status-indicator"></span>
                <span class="status-text">接続中...</span>
            </div>
        </header>
        
        <main class="chat-container">
            <!-- System Status Display -->
            <div class="system-status-container" id="systemStatusContainer">
                <div class="status-cards">
                    <div class="status-card cpu-card" id="cpuCard">
                        <div class="status-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                                <rect x="4" y="4" width="16" height="16" rx="2" stroke="currentColor" stroke-width="2"/>
                                <rect x="9" y="9" width="6" height="6" rx="1" stroke="currentColor" stroke-width="2"/>
                                <path d="M9 1V3M15 1V3M9 21V23M15 21V23M1 9H3M1 15H3M21 9H23M21 15H23" stroke="currentColor" stroke-width="2"/>
                            </svg>
                        </div>
                        <div class="status-content">
                            <div class="status-label">CPU</div>
                            <div class="status-value" id="cpuValue">--</div>
                            <div class="status-bar">
                                <div class="status-bar-fill" id="cpuBar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="status-card memory-card" id="memoryCard">
                        <div class="status-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                                <rect x="3" y="4" width="18" height="16" rx="2" stroke="currentColor" stroke-width="2"/>
                                <path d="M7 8V16M11 8V16M15 8V16M17 8V16" stroke="currentColor" stroke-width="2"/>
                            </svg>
                        </div>
                        <div class="status-content">
                            <div class="status-label">メモリ</div>
                            <div class="status-value" id="memoryValue">--</div>
                            <div class="status-bar">
                                <div class="status-bar-fill" id="memoryBar" style="width: 0%"></div>
                            </div>
                            <div class="status-detail" id="memoryDetail">-- / --</div>
                        </div>
                    </div>
                    
                    <div class="status-card disk-card" id="diskCard">
                        <div class="status-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                                <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2"/>
                            </svg>
                        </div>
                        <div class="status-content">
                            <div class="status-label">ディスク</div>
                            <div class="status-value" id="diskValue">--</div>
                            <div class="status-bar">
                                <div class="status-bar-fill" id="diskBar" style="width: 0%"></div>
                            </div>
                            <div class="status-detail" id="diskDetail">-- / --</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="messages-wrapper">
                <div class="messages" id="messages">
                    <div class="welcome-message">
                        <!-- メイン動画エリア -->
                        <div class="main-video-container">
                            <div id="mainVideo" class="main-video"></div>
                        </div>
                        

                    </div>
                </div>
            </div>
            
            <div class="input-container">
                <div class="message-input-wrapper">
                    <input type="text" id="messageInput" placeholder="メッセージを入力..." autocomplete="off" maxlength="500">
                    <div class="input-actions">
                        <button id="sendButton" type="button" class="send-btn">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                                <path d="M2 21L23 12L2 3V10L17 12L2 14V21Z" fill="currentColor"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <script src="/static/assets/video-component.js"></script>
    <script>
        // Simple and direct implementation
        let websocket = null;
        let isConnected = false;
        
        // DOM elements
        const cpuValue = document.getElementById('cpuValue');
        const memoryValue = document.getElementById('memoryValue');
        const diskValue = document.getElementById('diskValue');
        const cpuBar = document.getElementById('cpuBar');
        const memoryBar = document.getElementById('memoryBar');
        const diskBar = document.getElementById('diskBar');
        const memoryDetail = document.getElementById('memoryDetail');
        const diskDetail = document.getElementById('diskDetail');
        const messagesContainer = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const connectionStatus = document.getElementById('connectionStatus');
        
        function updateSystemStatus(data) {
            console.log('Updating system status:', data);
            
            // Update CPU
            if (data.cpu_percent !== undefined) {
                const cpuPercent = Math.round(data.cpu_percent);
                cpuValue.textContent = cpuPercent + '%';
                cpuBar.style.width = cpuPercent + '%';
                console.log('Updated CPU to:', cpuPercent + '%');
            }
            
            // Update Memory
            if (data.memory_percent !== undefined) {
                const memoryPercent = Math.round(data.memory_percent);
                memoryValue.textContent = memoryPercent + '%';
                memoryBar.style.width = memoryPercent + '%';
                
                if (data.memory_used && data.memory_total) {
                    const usedGB = (data.memory_used / (1024 ** 3)).toFixed(1);
                    const totalGB = (data.memory_total / (1024 ** 3)).toFixed(1);
                    memoryDetail.textContent = usedGB + 'GB / ' + totalGB + 'GB';
                }
                console.log('Updated Memory to:', memoryPercent + '%');
            }
            
            // Update Disk
            if (data.disk_percent !== undefined) {
                const diskPercent = Math.round(data.disk_percent);
                diskValue.textContent = diskPercent + '%';
                diskBar.style.width = diskPercent + '%';
                
                if (data.disk_used && data.disk_total) {
                    const usedGB = (data.disk_used / (1024 ** 3)).toFixed(0);
                    const totalGB = (data.disk_total / (1024 ** 3)).toFixed(0);
                    diskDetail.textContent = usedGB + 'GB / ' + totalGB + 'GB';
                }
                console.log('Updated Disk to:', diskPercent + '%');
            }
        }
        
        function addMessage(content, role) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ' + role;
            messageDiv.innerHTML = '<div class="message-content">' + content + '</div>';
            
            // Remove welcome message if it exists
            const welcomeMessage = messagesContainer.querySelector('.welcome-message');
            if (welcomeMessage) {
                welcomeMessage.remove();
            }
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        function connectWebSocket() {
            try {
                websocket = new WebSocket('ws://localhost:8002/ws');
                
                websocket.onopen = function(event) {
                    console.log('WebSocket connected');
                    isConnected = true;
                    connectionStatus.querySelector('.status-text').textContent = '接続済み';
                    connectionStatus.querySelector('.status-indicator').classList.add('connected');
                };
                
                websocket.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        console.log('Received message type:', data.type);
                        console.log('Full message data:', data);
                        
                        if (data.type === 'system_status_response' && data.data && data.data.system_status) {
                            console.log('Processing system_status_response');
                            updateSystemStatus(data.data.system_status);
                        } else if (data.type === 'system_status_update' && data.data) {
                            console.log('Processing system_status_update');
                            updateSystemStatus(data.data);
                        } else if (data.type === 'chat_response' && data.data && data.data.message) {
                            console.log('Processing chat_response:', data.data.message);
                            addMessage(data.data.message, 'assistant');
                        } else {
                            console.log('Unhandled message type or missing data:', data.type);
                        }
                    } catch (e) {
                        console.error('Error parsing message:', e);
                    }
                };
                
                websocket.onerror = function(error) {
                    console.error('WebSocket error:', error);
                    connectionStatus.querySelector('.status-text').textContent = 'エラー';
                };
                
                websocket.onclose = function(event) {
                    console.log('WebSocket closed');
                    isConnected = false;
                    connectionStatus.querySelector('.status-text').textContent = '切断';
                    connectionStatus.querySelector('.status-indicator').classList.remove('connected');
                };
                
            } catch (error) {
                console.error('WebSocket connection error:', error);
            }
        }
        
        function sendMessage() {
            const message = messageInput.value.trim();
            if (message && websocket && websocket.readyState === WebSocket.OPEN) {
                const messageData = {
                    type: 'chat_message',
                    message: message,
                    timestamp: new Date().toISOString()
                };
                
                console.log('Sending chat message:', messageData);
                websocket.send(JSON.stringify(messageData));
                addMessage(message, 'user');
                messageInput.value = '';
            } else {
                console.log('Cannot send message - WebSocket not ready or empty message');
                console.log('WebSocket state:', websocket ? websocket.readyState : 'null');
                console.log('Message:', message);
            }
        }
        
        // Event listeners
        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        // Video component initialization
        let mainVideoComponent = null;
        
        function initializeMainVideo() {
            // メイン動画の初期化（中央エリア用・音声ON）
            const videoSrc = '/static/assets/videos/apple.mp4';
            
            try {
                mainVideoComponent = new VideoComponent('mainVideo', {
                    videoSrc: videoSrc,
                    maskType: 'none', // マスクなし
                    size: 'custom', // カスタムサイズ（CSSで400x300px指定）
                    autoplay: true,
                    loop: true,
                    muted: false, // 音声ON！
                    controls: true, // コントロール表示
                    showMaskSelector: false // マスクセレクターを非表示
                });
                
                console.log('Main video initialized successfully with sound ON');
            } catch (error) {
                console.error('Failed to initialize main video:', error);
                showMainVideoPlaceholder();
            }
        }
        
        function showMainVideoPlaceholder() {
            const container = document.getElementById('mainVideo');
            container.innerHTML = `
                <div class="main-video-placeholder" style="
                    width: 400px; 
                    height: 300px; 
                    border-radius: 20px;
                    background: linear-gradient(45deg, #f0f0f0 25%, transparent 25%);
                    background-size: 20px 20px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: #666;
                    font-size: 16px;
                    border: 4px solid rgba(103, 126, 234, 0.3);
                ">
                    🎬 動画を読み込み中...
                </div>
            `;
        }
        
        // 動画ファイルの存在確認
        function checkVideoExists(videoSrc) {
            return fetch(videoSrc, { method: 'HEAD' })
                .then(response => response.ok)
                .catch(() => false);
        }
        
        // 音声付き動画の再生を開始（ユーザーインタラクション後）
        function enableMainVideoSound() {
            if (mainVideoComponent && mainVideoComponent.video) {
                mainVideoComponent.video.muted = false;
                mainVideoComponent.video.play().then(() => {
                    console.log('Main video playing with sound');
                }).catch(error => {
                    console.log('Autoplay with sound failed, user interaction required:', error);
                });
            }
        }
        
        // ページクリック時に音声を有効化
        function setupSoundActivation() {
            const activateSound = () => {
                enableMainVideoSound();
                document.removeEventListener('click', activateSound);
                document.removeEventListener('keydown', activateSound);
                console.log('Sound activation listeners removed');
            };
            
            document.addEventListener('click', activateSound);
            document.addEventListener('keydown', activateSound);
            console.log('Sound activation listeners added');
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, connecting WebSocket...');
            connectWebSocket();
            
            // 動画の初期化（少し遅延させて他の要素の読み込みを優先）
            setTimeout(() => {
                const videoSrc = '/static/assets/videos/apple.mp4';
                checkVideoExists(videoSrc).then(exists => {
                    if (exists) {
                        // 中央のメイン動画のみを初期化（音声ON・マスクなし）
                        initializeMainVideo();
                        // 音声有効化のためのユーザーインタラクション待機
                        setupSoundActivation();
                    } else {
                        console.log('Video not found, showing placeholder');
                        showMainVideoPlaceholder();
                    }
                });
            }, 1000);
        });
    </script>
</body>
</html>